<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
	<title></title>
	<script type="text/javascript" src="RTFWebsocket.js"></script>


	<script type="text/javascript">
		var objDebug;
		var objchkDebug;
		var g_seqNo = 1;
		var g_SessionID = "";
		var btnReqAgentData = null;
		var objLastResult = null;

		var urlParams;

		var TablesToDisplay =
		{
			ContactSessionState: {
				FeedName: "ContactSessionState", //"TestDataCache1" ,
				SendColumns: true,
				ChangeColumns: [],

				Columns: []
			}
			,

			LiveAgentStatus: {
				FeedName: "LiveAgentStatus", //"TestDataCache1" ,
				SendColumns: true,
				ChangeColumns: [],
				filter: [[
					{
						"ColumnName": "timeBucketId",
						"operation": "Equals",
						"Value": 1
					}
				]
				],
				Columns: ["recordId", "agentId", "agentName", "agentState"]
			},

			InboundLiveStatus: {
				FeedName: "InboundLiveStatus", //"TestDataCache2" ,
				SendColumns: true,
				ChangeColumns: [],
				filter: [
					[

						{
							"ColumnName": "timeBucketId",
							"operation": "Equals",
							"Value": 7
						}
						//,

						//                {
						//                    "ColumnName": "queueName",
						//                    "operation": "Equals",
						//                    "Value": "3333"
						//                }

					]
					//,
					//[

					//                    {
					//                        "ColumnName": "timeBucketId",
					//                        "operation": "Equals",
					//                        "Value": 7
					//                    }
					//    ,

					//                    {
					//                        "ColumnName": "queueName",
					//                        "operation": "Equals",
					//                        "Value": "Q5555ss"
					//                    }

					//]
				],
				Columns: ["queueId", "queueName", "currentTotalAgentReadyCount", "currentTotalAgentNotReadyCount", "currentTotalAgentTalkingCount"]
			}


		}


		function getURLParams() {
			var match,
				pl = /\+/g,  // Regex for replacing addition symbol with a space
				search = /([^&=]+)=?([^&]*)/g,
				decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
				query = window.location.search.substring(1);

			urlParams = {
				"user": "",
				"pass": ""
			};
			while (match = search.exec(query)) {
				urlParams[decode(match[1])] = decode(match[2]);
			}
		}

		function onbodyload() {
			// get references to frequently used controls
			objServer = document.getElementById("txtServer");
			objDebug = document.getElementById('txtDebug');
			objchkDebug = document.getElementById('chkDebug');
			objLastResult = document.getElementById('LastResult');
			btnReqAgentData = document.getElementById('btnReqAgentData');
			getURLParams();

			document.getElementById("txtUser").value = urlParams["user"];
			document.getElementById("txtPass").value = urlParams["pass"];
			document.getElementById("txtLocation").value = urlParams["Location"] || "myLocation";

			objServer.value = window.location.hostname;
			SetButtons(true);

			if (urlParams["autoStart"] == 1) {
				window.setTimeout(btnReqAgentData_Click, 100);
			}
		}

		function CreateRequest(SessionID) {
			var realTimeRequest = {																			// Create request object
				Location: document.getElementById("txtLocation").value,									// User location
				SeqNo: g_seqNo++,																		// sequence number for tracking
				Requests: []																			// create empty request array
			};

			if (SessionID != null && SessionID != "" && SessionID != '00000000-0000-0000-0000-000000000000') {
				realTimeRequest.SessionID = SessionID;																	// Current Session ID
			}
			else {
				realTimeRequest.Username = document.getElementById("txtUser").value;
				realTimeRequest.Password = document.getElementById("txtPass").value
			}
			return realTimeRequest;
		}

		function btnReqAgentData_Click() {
			//realtimeFeedHost = 'hot2756w10.qatestlab.lan';
			realtimeFeedHost = objServer.value;
			SetButtons(true);
			trace("btnReqAgentData_Click start seqNo: " + g_seqNo);
			var jsonStr = "";
			var realTimeRequest = CreateRequest(g_SessionID);					// Create request header

			for (var reqs in TablesToDisplay) {
				if (TablesToDisplay.hasOwnProperty(reqs)) {
					var req = TablesToDisplay[reqs];
					var req1 = {												// create request
						action: 'Add',
						FeedName: req.FeedName,//"TestDataCache1",				// we want to get AgentStatus data
						SendColumns: req.SendColumns,							// we want to see data headers in first response
						ChangeColumns: req.ChangeColumns,							            // Create empty array for columns changes,
						filters: req.filter,
						Columns: req.Columns

					};

					var Columns = document.getElementById("txtColumns").value;
					if (Columns.trim) {
						Columns = Columns.trim();
					}
					if (Columns.length > 0)										// do we want to only be notified when a column changes
					{
						var columnSplit = Columns.split(',');					// yes, so get which columns
						for (var i = 0; i < columnSplit.length; i++) {
							req1.ChangeColumns.push(columnSplit[i]); 			// add to ChangeColumns array
						}
					}


					realTimeRequest.Requests.push(req1);
				}
			}
			jsonStr = JSON.stringify(realTimeRequest, null, " ");
			trace(jsonStr);
			sendRequest(realTimeRequest);//jsonStr);

		}



		function sendRequest(data) {
			if (data) {
				sendData(webSocketRTF, data);
			}

		}

		function ProcessResponse(data) {
			SetStatusText(data.result);

			switch (data.result) {
				case 'OK':
					{
						trace("success result: " + data.result + " seqNo: " + data.SeqNo + " SessionID: " + data.SessionID);
						SetStatusText("OK. Processing...");
						for (var iDataCache = 0; iDataCache < data.responses.length; iDataCache++) {
							var headers = data.responses[iDataCache].Columns;
							var AgtStatus = data.responses[iDataCache].Rows;

						}
						SetStatusText("OK. Done...");
						break;
					}
				case "NoRequestsPending":
					{
						window.setTimeout("btnReqAgentData_Click();", 100);
						break;
					}
				case "Poll":
					{
						sendPoll();
						break;
					}
				case "Bumped":
					{
						trace("result: " + data.result + " seqNo: " + data.SeqNo + " SessionID: " + data.SessionID, true);
						//SessionID = "";  why?
						break;
					}
				default:
					{
						trace("result: " + data.result + " seqNo: " + data.SeqNo + " SessionID: " + data.SessionID, true);
						g_SessionID = "";

						break;
					}
			}

			SetButtons(false);

		}

		function ProcessError(textStatus) {
			trace("error: " + text, true);
			SetStatusText(textStatus);

			ClearTable();
			SetButtons(true);

		}
		function SetStatusText(text) {
			var dateVar = new Date();
			var datestr = AddLeadingZero(dateVar.getHours()) + ':' + AddLeadingZero(dateVar.getMinutes()) + ':' + AddLeadingZero(dateVar.getSeconds()) + '.' + dateVar.getMilliseconds() + ">";

			objLastResult.innerText = datestr + "> " + text;
		}

		function AddLeadingZero(number) {
			return (number < 10 ? "0" : "") + number;
		}

		var debugList = [];
		function trace(text, bShow) {
			if (objchkDebug.checked || bShow) {
				var dateVar = new Date();
				var datestr = AddLeadingZero(dateVar.getHours()) + ':' + AddLeadingZero(dateVar.getMinutes()) + ':' + AddLeadingZero(dateVar.getSeconds()) + '.' + dateVar.getMilliseconds() + ">";

				debugList.push(datestr + text + "<br>");
				if (debugList.length > 40) {
					debugList.shift();
				}
				var text = debugList.join();
				objDebug.innerHTML = text;
				objDebug.scrollTop = objDebug.scrollHeight - objDebug.clientHeight;

			}
			else {
				console.log(text);
			}
		}

		function SetButtons(bEnable) {
			if (btnReqAgentData == null) {
				btnReqAgentData = document.getElementById('btnReqAgentData');
			}
			btnReqAgentData.disabled = !bEnable;
		}

		function ClearDebug() {
			objDebug.innerHTML = "";
			debugList = [];
		}
	</script>
</head>

<body onload="onbodyload();" style="white-space:nowrap;overflow:hidden">
	Server <input id="txtServer" type="text" />
	Username <input id="txtUser" type="text" />
	Password <input id="txtPass" type="password" />

	<button id="btnReqAgentData" onclick="btnReqAgentData_Click();"> Request Agent Data</button>
	Location <input id="txtLocation" type="text" value="MyLocation" />
	Columns <input id="txtColumns" type="text" value="" /> <br />
	LastResult [<span id="LastResult"></span>]s
	Show debug<input id="chkDebug" type="checkbox" value="Show debug" checked="checked" /> Double Click debug area to
	clear<br />


	<span id="txtDebug" ondblclick="ClearDebug();" style="white-space:nowrap; height:90%; width:99%; overflow-y:scroll; overflow-x:scroll; border:1px; display:block;"></span>
</body>

</html>